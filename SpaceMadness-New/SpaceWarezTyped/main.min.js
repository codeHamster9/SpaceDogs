function gameLoop(){frameCounter++,IsGameStarted?myShip.life==0?(canvas.textContent="GameOver",myShip.isHelmsLocked=!0,drawBackground(),drawScores(),drawExtraLife(wingMan),drawRocks(),drawBonus(),drawLifeBar(myShip),drawLifeBar(wingMan),drawPlayer(myShip),drawPlayer(wingMan),drawText(canvas.textContent,canvas.clientWidth/2-100,canvas.clientHeight/2),updateBonus(),updateBonusEffect(wingMan)):(player1Score.value++,player2Score.value++,drawBackground(),drawScores(),drawExtraLife(wingMan),drawExtraLife(myShip),drawRocks(),drawBonus(),drawLifeBar(myShip),drawLifeBar(wingMan),drawPlayer(myShip),drawPlayer(wingMan),drawText(canvas.textContent,canvas.clientWidth/2-100,canvas.clientHeight/2),checkColision(),updateBonus(),updateBonusEffect(wingMan),updateBonusEffect(myShip)):frameCounter%60==0&&frameCounter<420&&drawTimer(CountdownTimer),window.requestAnimationFrame(gameLoop)}function drawBackground(){var n,t;if(context.clearRect(0,0,canvas.width,canvas.height),context.drawImage(imageObjBackground,0,backgroundVelocity),DEBUG&&(context.drawImage(imageObjBackground,0,-1*(imageObjBackground.height-backgroundVelocity)),backgroundVelocity>imageObjBackground.height&&(backgroundVelocity=0),frameCounter%1200==0&&backGroundProgress<10&&(backGroundProgress+=2),backgroundVelocity+=backGroundProgress),DEBUG){for(n=50;n<900;n+=50)context.beginPath(),context.moveTo(n,0),context.lineTo(n,490),context.closePath(),context.lineWidth=2,context.strokeStyle="rgba(255,0,0,0.2)",context.stroke();for(t=50;t<550;t+=50)context.beginPath(),context.moveTo(0,t),context.lineTo(900,t),context.closePath(),context.lineWidth=2,context.strokeStyle="rgba(255,0,0,0.2)",context.stroke()}}function drawLifeBar(n){var t=100+n.damageBar;context.beginPath(),n.id=="myShip"?(context.moveTo(10,100),context.lineTo(10,490),context.lineTo(30,490),context.lineTo(30,100),context.lineTo(10,100)):(context.moveTo(870,100),context.lineTo(870,490),context.lineTo(890,490),context.lineTo(890,100),context.lineTo(870,100)),context.closePath(),context.lineWidth=5,context.strokeStyle="blue",context.stroke(),context.beginPath(),n.id=="myShip"?(context.moveTo(11,t),context.lineTo(11,489),context.lineTo(29,489),context.lineTo(29,t),context.lineTo(11,t)):(context.moveTo(871,t),context.lineTo(871,489),context.lineTo(889,489),context.lineTo(889,t),context.lineTo(871,t)),context.fillStyle="rgba(255,0,0,0.5)",context.fill(),context.closePath()}function drawPlayer(n){if(n.isHit)drawExplosion(n);else if(context.drawImage(n.image,n.x,n.y,n.width,n.height),DEBUG){var t=getCenterPoint(n);context.beginPath(),context.arc(t.x,t.y,n.width/2+3,0,2*Math.PI,!1),context.fillStyle="rgba(125,255,125,0.5)",context.closePath(),context.fill(),context.beginPath(),context.arc(t.x,t.y,3,0,2*Math.PI,!1),context.fillStyle="rgba(255,0,0,1.5)",context.closePath(),context.fill(),context.beginPath(),context.fillStyle="rgba(255,255,255,1.5)",context.font="italic bold 15px sans-serif",context.textBaseline="center",context.fillText(n.x+","+n.y,n.x+50,n.y),context.closePath(),context.fill()}n.Transform}function drawScores(){context.fillStyle="rgba(255,0,0,0.5)",context.font="italic bold 30px sans-serif",context.textBaseline="bottom",context.fillText(player1Score.value,player1Score.x,player1Score.y),context.fillText(player2Score.value,player2Score.x,player2Score.y)}function drawTimer(n){context.clearRect(0,0,canvas.width,canvas.height),context.drawImage(imageObjBackground,0,0),drawLifeBar(myShip),drawLifeBar(wingMan),drawPlayer(myShip),drawPlayer(wingMan),context.fillStyle="rgba(255,0,0,0.5)",context.font="italic bold 70px sans-serif",context.textBaseline="bottom",context.fillText(n,430,280),CountdownTimer--,CountdownTimer<0&&(IsGameStarted=!0)}function drawBonus(){bonusArr!=null&&$.each(bonusArr,function(n,t){if(context.drawImage(imageBonus,t.x,t.y),DEBUG){var i=getCenterPoint(t);context.beginPath(),context.fillStyle="rgba(255,255,255,1.5)",context.font="italic bold 15px sans-serif",context.textBaseline="center",context.fillText(n,t.x,t.y),context.fill(),context.closePath()}})}function drawRocks(){for(var n=0;n<rocksArr.length;++n)drawRotatedImage(rocksArr[n]),rocksArr[n].angle+=rocksArr[n].rotationSpeed,DEBUG&&(context.beginPath(),context.arc(rocksArr[n].x,rocksArr[n].y,rocksArr[n].width/2-3,0,2*Math.PI,!1),context.fillStyle="rgba(255,255,0,0.2)",context.closePath(),context.fill(),context.beginPath(),context.arc(rocksArr[n].x,rocksArr[n].y,3,0,2*Math.PI,!1),context.fillStyle="rgba(255,0,0,1.5)",context.closePath(),context.fill(),myShip.life>0&&(context.beginPath(),context.fillStyle="rgba(255,255,255,1.5)",context.font="italic bold 15px sans-serif",context.textBaseline="center",context.fillText(rocksArr[n].distance,rocksArr[n].x-40,rocksArr[n].y+10),context.closePath(),context.fill()),context.beginPath(),context.fillStyle="rgba(255,255,255,1.5)",context.font="italic bold 15px sans-serif",context.textBaseline="center",context.fillText(rocksArr[n].x+","+rocksArr[n].y,rocksArr[n].x+20,rocksArr[n].y-10),context.closePath(),context.fill()),rocksArr[n].y>550?hub.server.initRock(n,qs.roomId):rocksArr[n].y=rocksArr[n].y+rocksArr[n].speed}function drawExplosion(n){n.isDead?drawDeathExplosion(n):n.frameIndex<explosionArray.length?(context.drawImage(n.image,n.x,n.y,n.width,n.height),context.drawImage(explosionArray[n.frameIndex].image,n.x,n.y+10,60,60),n.frameIndex++):n.isHit=!1}function drawDeathExplosion(n){n.frameIndex<explosionArray.length?(context.drawImage(explosionArray[n.frameIndex].image,n.x,n.y),n.frameIndex++):(n.isHit=!1,n.isDead=!1)}function drawText(n,t,i){context.fillStyle="rgba(255,0,0,0.3)",context.font="italic bold 35px sans-serif",context.textBaseline="bottom",context.fillText(n,t,i)}function drawRotatedImage(n){context.save(),context.translate(n.x,n.y),context.rotate(n.angle*TO_RADIANS),context.drawImage(imageRock,-(n.width/2),-(n.height/2),n.width,n.height),context.restore()}function drawExtraLife(n){var t,i;switch(n.id){case"myShip":for(t=160,i=0;i<n.life;i++)context.drawImage(n.image,t,10,30,30),t+=40;break;case"wingMan":for(t=620,i=0;i<n.life;i++)context.drawImage(n.image,t,10,30,30),t+=40}}function checkColision(){var t,n;if(collidables=rocksArr,bonusArr&&(collidables=collidables.concat(bonusArr)),collidables=collidables.concat(wingMan),!myShip.isDead&&myShip.life>0)for(t=getCenterPoint(myShip),n=0;n<collidables.length;++n){var r=t.x-collidables[n].x,u=t.y-collidables[n].y,i=Math.round(Math.sqrt(r*r+u*u)),f=collidables[n].width/2,e=13;if(DEBUG&&(collidables[n].distance=i),i<f+e){DEBUG&&console.log("distance:",i,"radius:",f+e);switch(collidables[n].type){case"rock":myShip.shieldsUp||(updateScore(1,"hit"),myShip.explode(),hub.server.playerExplode(n,qs.roomId));break;case"item":myShip.fx&&myShip.fx.clearFX(myShip),myShip.isUnderEffect=!0;switch(collidables[n].name){case 0:updateScore(1,"bonus"),console.log("points");break;case 1:myShip.fx=new effects.shieldFx(myShip),canvas.textContent="Shields Up!";break;case 2:myShip.fx=new effects.shrinkFx(myShip),canvas.textContent="Shrink Ray!";break;case 3:myShip.fx=new effects.drunkFx(myShip,20),canvas.textContent="Drunk Driving!"}collidables[n].timeout=0,hub.server.playerTakesBonus(collidables[n].name,n);break;case"ship":myShip.isUnderEffect=!0,myShip.isHelmsLocked=!0,myShip.x>wingMan.x?(myShip.fx=new effects.bumpFX(myShip,!0),hub.server.playerBump(!1)):(myShip.fx=new effects.bumpFX(myShip,!1),hub.server.playerBump(!0))}}}}function updateBonus(){IsGameStarted&&bonusArr!=null&&$.each(bonusArr,function(n,t){t!=null&&t.timeout>0?t.timeout--:(DEBUG,bonusArr.splice(n,1))})}function updateScore(n,t){switch(t){case"bonus":myShip.isUnderEffect=!1;switch(n){case 1:player1Score.value+=SCOREBONUS;break;case 2:player2Score.value+=SCOREBONUS}break;case"hit":switch(n){case 1:player1Score.value>HIT_VALUE?player1Score.value-=HIT_VALUE:player1Score.value=0;break;case 2:player2Score.value>HIT_VALUE?player2Score.value-=HIT_VALUE:player2Score.value=0}}}function updateBonusEffect(n){n.isUnderEffect&&n.applyEffect()}function whatKey(n){if(!myShip.isHit&&!myShip.isHelmsLocked){var t=0;myShip.oldX=myShip.x,myShip.oldY=myShip.y;switch(n.keyCode){case 37:myShip.x=myShip.x-30,myShip.x<30&&(myShip.x=30,t=1);break;case 39:myShip.x=myShip.x+30,myShip.x>backGroundX-30&&(myShip.x=backGroundX-30,t=1);break;case 40:myShip.y=myShip.y+30,myShip.y>backGroundY&&(myShip.y=backGroundY,t=1);break;case 38:myShip.y=myShip.y-30,myShip.y<0&&(myShip.y=0,t=1);break;case 89:isReadyToExit&&hub.server.endGame(qs.roomId,player1Score.value);break;case 27:isReadyToExit=!0,showMessage("Are You Sure Y/N ?");break;case 78:showMessage("Click 'Esc' to exit the room !!!"),isReadyToExit=!1}t&&!myShip.isHelmsLocked?(myShip.x=myShip.oldX,myShip.y=myShip.oldY):hub.server.shipMove(myShip.x,myShip.y,"")}}function mouseMove(n){n.clientX<backGroundX-30&&n.clientY<backGroundY-10&&n.clientX>30&&n.clientY>50&&n.clientX>0&&n.clientY>0?(n.preventDefault(),myShip.isHit||!IsGameStarted||myShip.isHelmsLocked||(myShip.x=n.clientX,myShip.y=n.clientY,hub.server.shipMove(myShip.x,myShip.y,"")),this.style.cursor="none"):this.style.cursor="auto"}function getUrlVars(){for(var i=[],n,r=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),t=0;t<r.length;t++)n=r[t].split("="),i.push(n[0]),i[n[0]]=n[1];return i}function getCenterPoint(n){return{x:Math.round(n.x+n.width/2),y:Math.round(n.y+n.height/2)}}function showMessage(n){$("#ClientMessages").text(n).show()}var canvas,context,hub,imageObjBackground=new Image,imageRock=new Image,imageBonus=new Image,DEBUG=!1,SCOREBONUS=1e3,HIT_VALUE=500,collidables,myShipImageUrl="Images/spaceship1.png",wingManImageUrl="Images/spaceship2.png",rockImageUrl="Images/asteroid.png",backgroundImageUrl="Images/space_background.jpg",bonusImageUrl="Images/bonus1.png",backgroundVelocity=0,backGroundX=840,backGroundY=440,Damage_MAX=420,Hit_Damage=35,frameCounter=0,explosionArray=[],shipTransform=[],bonusArr,rocksArr,TO_RADIANS=Math.PI/180,myShip,wingMan,CountdownTimer=1,IsGameStarted=!1,isReadyToExit=!1,qs={roomId:"",userId:""},player1Score={x:60,y:35,value:0},player2Score={x:750,y:35,value:0},FPS=0,backGroundProgress=0;window.onload=function(){var t,i,r,n;for(window.requestAnimationFrame=function(){return window.requestAnimationFrame}(),t=getUrlVars(),qs.userId=t.userId,qs.roomId=t.roomId,window.hasOwnProperty("prompt")&&delete window.prompt,qs.userId==null&&(qs.userId=window.prompt("enterName","guest")),canvas=document.getElementById("myCanvas"),context=canvas.getContext("2d"),window.addEventListener?(canvas.addEventListener("mousemove",mouseMove,!1),window.addEventListener("keydown",whatKey,!1)):window.attachEvent&&(canvas.attachEvent("onmousemove",mouseMove),window.attachEvent("onkeydown",whatKey)),imageRock.src=rockImageUrl,imageObjBackground.src=backgroundImageUrl,imageBonus.src=bonusImageUrl,myShip=new spaceShip("myShip",myShipImageUrl,200,430),wingMan=new spaceShip("wingMan",wingManImageUrl,700,430),i=0,n=0;n<35;n++)explosionArray[n]={image:new Image},explosionArray[n].image.src="Images/Frames/e"+(i+1)+".png",n%5==0&&i++;for(r=0,n=0;n<140;n++)shipTransform[n]={image:new Image},shipTransform[n].image.src="Images/New ship/tmp-"+r+".gif",n%4==0&&r++;qs.roomId==null&&(qs.roomId="r1 "),$.connection.hub.qs=qs,hub=$.connection.spaceHub,hub.client.wingManMove=function(n,t){IsGameStarted&&(wingMan.x=n,wingMan.y=t)},hub.client.wingManExplode=function(){IsGameStarted&&(wingMan.takeHit(),updateScore(2,"hit"))},hub.client.wingmanTakeBonus=function(n,t){collidables[t].timeout=0,wingMan.isUnderEffect=!0,wingMan.fx&&wingMan.fx.clearFX(wingMan);switch(collidables[t].name){case 0:wingMan.isUnderEffect=!1,updateScore(1,"bonus"),console.log("points");break;case 1:wingMan.fx=new effects.shieldFx(wingMan);break;case 2:wingMan.fx=new effects.shrinkFx(wingMan);break;case 3:wingMan.fx=new effects.drunkFx(wingMan,20)}},hub.client.wingmanBump=function(n){myShip.fx=new effects.bumpFX(myShip,n),myShip.isUnderEffect=!0,console.log("bumped")},hub.client.setRockData=function(n){rocksArr[n.index]=new spaceRock(n)},hub.client.setRockArray=function(n){rocksArr==null&&(rocksArr=[]),rocksArr=n},hub.client.addRock=function(n){rocksArr.length<20&&rocksArr.push(n),DEBUG&&console.log("rockAdded - Array Length : ",rocksArr.length)},$.connection.hub.start().done(function(){console.log(qs),$.ajax("http://localhost:49950/Lobby/RegisterPlayerName",{success:function(){console.log("success")},error:function(n){console.log(n.statusText)},data:{userId:qs.userId},dataType:"json",type:"POST",async:!0})}),hub.client.startGame=function(n){if(n==2){var t=wingMan;wingMan=myShip,myShip=t,player1Score.x=player1Score.x+player2Score.x,player2Score.x=player1Score.x-player2Score.x,player1Score.x=player1Score.x-player2Score.x,FPS=1e3/60,backGroundProgress=2,hub.server.initRockArray(qs.roomId)}showMessage("Click 'Esc' to exit the room !!!"),gameLoop()},hub.client.playerWait=function(){showMessage("Wait for another player to arrive ..."),drawBackground(),drawScores(),drawLifeBar(myShip),drawLifeBar(wingMan),drawPlayer(myShip),drawPlayer(wingMan)},hub.client.redirectToLobby=function(n,t){showMessage(t),FPS=0;var i=n+"?"+qs.userId+":"+player1Score.value;$.ajax(n,{success:function(){console.log("success")},error:function(n){console.log(n.statusText)},data:{roomId:qs.roomId,score:player1Score.value},dataType:"json"})},hub.client.setBonusData=function(n){if(n!=null){DEBUG&&console.log("server bonus payload : ",n.length),bonusArr==null&&(bonusArr=[]);for(var t=0;t<n.length;t++)bonusArr[t]=new bonusItem(n[t])}}},imageObjBackground.onload=function(){context.drawImage(imageObjBackground,0,0)}